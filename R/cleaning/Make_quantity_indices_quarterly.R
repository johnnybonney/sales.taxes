### In this R-file we create a quarterly and a yearly file with all Nielsen data and tax rate information

library(data.table)
library(lfe)
library(futile.logger)
library(AER)
library(readstata13)


setwd("/project2/igaarder")


## input filepaths ----------------------------------------------
output_dir <- "/project2/igaarder/Data/Nielsen/"
brand_dir <- "/project2/igaarder/Data/Nielsen/Temporary/module_brand_by_module/"
output.upc_dir <- "/project2/igaarder/Data/Nielsen/UPC_FE_price_indices/UPC_FE_sem/"
output.index_dir <- "/project2/igaarder/Data/Nielsen/UPC_FE_price_indices/sem_pindex/"

## Lists of module codes
food1 <- c("0501M1272", "0501M1276", "0503M1492", "0503M1493", "0503M1494", "0503M1498", "0505M1532", "0506M1421", "0507M1030", "0507M1033", "0507M1040", "0507M1042", "0507M1044", "0507M1055", "0508M1303", "0508M1306", "0508M1309", "0508M1311", "0508M1313", "0510M1063", "0510M1225", "0510M1269", "0511M1257", "0511M1320", "0511M1340", "0512M1209", "0513M1290", "0513M1293", "0514M1105")
food2 <- c("1004M1351", "1004M1441", "1004M1445", "1005M1344", "1005M1348", "1006M1463", "1006M1465", "1007M1100", "1007M1114", "1007M1120", "1008M1455", "1010M1425", "1011M1506", "1011M1507", "1011M1508", "1012M3629", "1013M1331", "1013M1334", "1014M1168", "1015M1175", "1015M1177", "1016M1192", "1016M1193", "1017M1479", "1018M1403", "1018M1535", "1019M1405", "1020M1458", "1020M1461", "1021M1319")
food3 <- c("1501M4000", "1501M4001", "1501M4002", "1501M4003", "1501M4004", "1501M4005", "1501M4006", "1501M4008", "1503M1484", "1503M1553", "1505M1362", "1507M1271", "1507M1318", "1507M1323", "1507M1325", "1507M1326", "1507M1327", "1507M1329", "1507M1330", "1507M1333", "1507M1341", "1507M1452", "1508M1050", "1508M1487", "2001M2654", "2002M2629", "2002M2659", "2003M2664")
food4 <- c("2003M2665", "2004M2610", "2005M2672", "2005M2675", "2007M2628", "2007M2631", "2008M2615", "2008M2619", "2008M2621", "2008M2622", "2008M2623", "2008M2624", "2008M2625", "2009M2681", "2009M2682", "2009M2688", "2010M2634", "2010M2640", "2501M3608", "2501M3611", "2502M3546", "2502M3548", "2502M3550", "2502M3556", "2502M3586", "2502M3588", "2502M3590", "2502M3606", "2503M3604", "2503M3605", "2504M3595", "2505M4100")
food5 <- c("2506M3592", "2506M3625", "2506M3627", "2506M3628", "2507M3566", "2508M3602", "2510M3603", "2510M3612", "3001M3544", "3001M3560", "3001M3564", "3001M3580", "3001M3597", "3001M3598", "3002M3572", "3002M3574", "3002M3576", "3002M3577", "3002M3578", "3002M3618", "3501M3561", "4001M4010", "4001M4023", "4001M4050", "4001M4060", "4001M4225", "4001M4275", "4001M4280", "4001M4350", "4001M4400", "4001M4470", "4001M4475")
## Excluded , "1506M1356", "1506M1360" from food3

nonfood1 <- c("4501M7003", "4501M7008", "4501M7012", "4501M7020", "4502M8444", "4503M7215", "4503M7226", "4504M7106", "4504M7150", "4505M7130", "4505M7825", "4505M7845", "4506M7060", "4506M7062", "4506M7080", "4506M7850", "4507M7242", "4507M7245", "4507M7250", "4507M7260", "4507M7335", "4507M7340", "4507M7734")
nonfood2 <- c("4508M7034", "4508M7035", "4508M7036", "4509M6025", "4509M7453", "4509M7454", "4510M7460", "4510M7465", "4511M7275", "4511M7295", "4511M7305", "4511M7306", "5001M5000", "5001M5010", "5001M5015", "5002M5026", "5002M5033", "5002M5034", "5002M5039", "5002M5048", "5003M5050", "5003M5052", "5003M5057", "5502M7870")
nonfood3 <- c("5503M8902", "5505M7370", "5506M7785", "5507M7736", "5507M8900", "5507M8903", "5509M7741", "5509M7746", "5511M6017", "5513M7755", "5513M7772", "5513M7778", "5513M7781", "5513M7782", "5513M7783", "5515M6023", "5515M7509", "5515M7786", "5516M6029", "5516M7880", "5517M7410", "5517M7421", "5522M6010", "5522M7630")
nonfood4 <- c("5522M7633", "5522M7660", "6001M6003", "6002M8455", "6002M8457", "6002M8462", "6002M8467", "6002M8468", "6003M8418", "6003M8419", "6003M8423", "6003M8425", "6004M8449", "6005M1531", "6007M8438", "6008M8435", "6008M8440", "6008M8512", "6009M8465", "6010M6009", "6010M6030", "6011M8470", "6011M8471", "6011M8472")
nonfood5 <- c("6011M8473", "6011M8478", "6012M8301", "6012M8412", "6012M8420", "6012M8421", "6012M8427", "6012M8434", "6012M8436", "6012M8514", "6012M8528", "6014M8403", "6014M8404", "6014M8613", "6015M7265", "6015M7270", "6016M8487", "6016M8556", "6017M8431", "6017M8459", "6017M8460", "6017M8519", "6018M8397", "6018M8398", "6018M8400", "6018M8413", "6018M8414")

list.modules <- c(food1, food2, food3, food4, food5, nonfood1, nonfood2, nonfood3, nonfood4, nonfood5)


all_pi <- data.table(NULL)
for(i in 1:length(list.modules)) {

  ##
  code <- list.modules[i]

  ##Extract group and module
  group <- substr(code, 1, 4)
  module <- substr(code, 6, 9)

  index.input <- paste(output.index_dir, "Quantity_index_group_", group, "_module_", module, ".csv", sep = "")

  mod.qi <- fread(index.input)
  mod.qi <- mod.qi[, c("store_code_uc", "product_module_code", "year", "quarter", "quant_index", "exp_UPC", "quantity")]
  # Among others I got rid of variable net_UPC
  
  all_pi <- rbind(all_pi, mod.qi)
}

all_pi[, quant_index := log(quant_index)]
all_pi[, exp_UPC := log(exp_UPC)]
all_pi[, quantity := log(quantity)]


names(all_pi) <- c("store_code_uc", "product_module_code", "year", "quarter", "ln_quantity3", "ln_UPC", "ln_raw_quant")
fwrite(all_pi, "Data/Nielsen/Quarterly_quantity_quality_indices.csv")
